{% extends "base.html" %}
{% from "_formhelpers.html" import render_field %}

{% macro tabnav(day, full_day, active_day) %}
    <li id="tabnav-{{day}}" role="presentation" {%- if active_day == day %} class="active" {% endif %}>
        <a href="{{ url_for('.schedule', day=day) }}" aria-controls="{{ day }}" role="tab">{{ full_day }}</a>
    </li>
{% endmacro %}

{% block title %}
    Volunteer Schedule
{% endblock %}
{% block body %}
    {% include "volunteer/_nav.html" %}
    <noscript>
        <div class="well">
            This page requires Javascript.
        </div>
    </noscript>

    {% if untrained_roles %}
        <div class="alert alert-info">
            You still need training before starting a shift for the following roles:
            <ul class="list-unstyle">
                {% for role in untrained_roles %}
                    <li>{{ role.name }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    {% include "volunteer/_schedule_filters.html" %}

    <ul class="nav nav-tabs" role="tablist">
        {{ tabnav('wed', 'Wednesday', active_day) }}
        {{ tabnav('thu', 'Thursday', active_day) }}
        {{ tabnav('fri', 'Friday', active_day) }}
        {{ tabnav('sat', 'Saturday', active_day) }}
        {{ tabnav('sun', 'Sunday', active_day) }}
        {{ tabnav('mon', 'Monday', active_day) }}
    </ul>
    <div class="tab-content table-responsive">
        <div role="tabpanel" class="tab-pane active" id="{{ active_day }}">
            <table id="tab-{{ active_day }}" class="table table-bordered shifts-table">
                <thead><tr>
                    <th>Starts</th>
                    <th>Ends</th>
                    <th>Venue</th>
                    <th>Role</th>
                    <th>People</th>
                    <th></th>
                </tr></thead>
                <tbody id="tbody-{{ active_day }}">
                    {% for hour in all_shifts | sort %}
                        {% for shift in all_shifts[hour] %}
                            <tr id="shift-{{ shift.id }}" data-role-id="{{ shift.role.id }}" data-shift-start="{{ hour }}" data-shift-end="{{ shift.end_time }}" data-staffed="{{ shift.current_count >= shift.min_needed }}" data-full="{{ shift.current_count >= shift.max_needed }}" data-signed-up="{{ shift.is_user_shift }}" data-min-staff="{{ shift.min_needed }}" data-max-staff="{{ shift.max_needed }}" data-current-staff="{{ shift.current_count }}">
                                {% if loop.first %}
                                    <td rowspan="{{ all_shifts[hour] | length }}">{{ hour }}</td>
                                {% else %}
                                    <td style="display: none">{{ hour }}</td>
                                {% endif %}
                                <td>{{ shift.end_time if shift.end else '--' }}</td>
                                <td>{{ shift.venue.name }}</td>
                                <td>{{ shift.role.name }}</td>
                                <td>{{ shift.current_count }}/{{ shift.max_needed }}</td>
                                {% if current_user.has_permission("volunteer:admin") %}
                                    <td><a href="{{ url_for('.shift', shift_id=shift.id) }}" class="btn btn-block btn-primary">Details</a></td>
                                {% else %}
                                    <td>
                                            {%- if shift.is_user_shift -%}
                                                <form method="post" action="{{ url_for('.shift_cancel', shift_id=shift.id) }}">
                                                    <button class="btn btn-block btn-danger">Cancel</button>
                                                </form>
                                            {%- else -%}
                                                <form method="post" action="{{ url_for('.shift_sign_up', shift_id=shift.id) }}">
                                                    <button class="btn btn-block btn-success">Sign Up</button>
                                                </form>
                                            {%- endif -%}
                                        </form>
                                    </td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}
{% block foot %}
    <script src="{{ static_url_for('static', filename='js/volunteer-schedule.js') }}"></script>
{% endblock %}
